<mat-card>
  <div id="info">
    <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#joinHelp">
      <svg viewBox="0 0 24 24">
        <path fill="#000000" d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
      </svg>
    </button>
  </div>

  <mat-card-content>
    <mat-label *ngIf="errData">Choose semantic to get tables</mat-label>
    <form #selectedTablesForm="ngForm">
      <mat-grid-list cols="12" rowHeight="4:3" *ngFor="let selected of selectedTables; index as rowIndex; last as isLastTable; first as isFirstTable">
        <!-- <mat-grid-tile colspan="3" *ngIf="tables['tables'].length || tables['custom tables'].length"> -->
        <mat-grid-tile colspan="3">
          <mat-form-field>
            <mat-label>Select table/custom table</mat-label>
            
            <!-- <mat-select-search [formControl]=""></mat-select-search> -->
            <mat-select (click)="rowIndex === 1 ? onTableClick($event) : ''" [(ngModel)]="selected.tableId" name="table-{{rowIndex}}" (selectionChange)="setSelectedTable(selected,rowIndex)"
              [disabled]="selected.disabled" required>
              <!-- <input matInput placeholder="search table" (input)="filterTable($event.target.value)"/> -->
              <input matInput placeholder="search table" class= "filter-input" (input)="filterTable($event.target.value, rowIndex)"/>
              <div *ngIf="!noEntriesFoundTable" class="pl-18">
                No Entries found
              </div>

              <mat-optgroup label="Related Tables" [hidden]="!selected.tables['related tables'].length || isLoadingRelated || rowIndex !== 1">
                <mat-option *ngFor="let table of selected.tables['related tables']" [value]="table['mapped_table_id']" title="Join Type: {{table.join_type}} &#013; Primary Key: {{table.primary_key}} &#013; Foreign Key: {{table.foreign_key}}">
                  {{table.mapped_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Tables" [hidden]="!selected.tables['tables'].length  || isLoadingRelated">
                <mat-option *ngFor="let table of selected.tables['tables']" [value]="table['sl_tables_id']" title="{{table.mapped_table_name | uppercase}}">
                  {{table.mapped_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Custom Tables" [hidden]="!selected.tables['custom tables'].length || isLoadingRelated">
                <mat-option *ngFor="let table of  selected.tables['custom tables']" [value]="table['custom_table_id']" title="{{table.custom_table_name | uppercase}}">
                  {{table.custom_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
              <div *ngIf="isLoadingRelated" class="text-center">
                  <img src= "assets/spinner.gif" class="spinner">
              </div>    
            </mat-select>
            <mat-error> Please select a table </mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <!-- <mat-grid-tile colspan="3">
          <mat-form-field *ngIf="selected.table">
            <mat-label>Select Columns</mat-label>
            <mat-select *ngIf="selected['table']['mapped_column_name']" multiple [(ngModel)]="selected['columns']"
              title="{{selected.columns.includes('all') ? selected.columns.slice(1) : selected.columns}}" name="columns-{{rowIndex}}" (selectionChange)="onTableColumnSelect($event, selected, rowIndex)" 
              [disabled]="selected.disabled">
              <mat-select-trigger>
                {{selected.columns.includes('all') ? selected.columns.slice(1) : selected.columns}}
              </mat-select-trigger>
              <mat-option [value]="'all'"><strong>Select All</strong></mat-option>
              <mat-option *ngFor="let column of selected['table']['column_properties']" [value]="column['column']" 
                title="{{column['column'] | uppercase}}">
                {{column['column'] | uppercase}}
              </mat-option>
            </mat-select>
            <mat-error> Please select atleast one column</mat-error>
          </mat-form-field>
        </mat-grid-tile> -->

        <mat-grid-tile colspan="3">
          <mat-form-field *ngIf="selected.table">
            <mat-label>Select Columns</mat-label>
            <mat-select *ngIf="selected['table']['mapped_column_name']" multiple [(ngModel)]="selected['columns']"
              title="{{selected.columns.includes('all') ? selected.columns.slice(1) : selected.columns}}" name="columns-{{rowIndex}}" (selectionChange)="onTableColumnSelect($event, selected, rowIndex)" 
              [disabled]="selected.disabled">

              <input matInput placeholder="search Column" class= "filter-input" (input)="filterColumn($event.target.value,rowIndex)"/>
              
              <mat-select-trigger>
                {{selected.columns.includes('all') ? selected.columns.slice(1) : selected.columns}}
              </mat-select-trigger>
              <mat-option [value]="'all'"><strong>Select All</strong></mat-option>
              <div *ngIf="!noEntriesFoundColumn">
                  No Entries found
              </div>
              <div *ngFor="let column of selected['table']['column_properties'];index as colIndex">
                <mat-option class="column-alias" [value]="column['column']"  style="width: 50%;display: inline-block;" title="{{column['column'] | uppercase}}">
                  {{column['column'] | uppercase}}
                </mat-option>
                <input [(ngModel)]="selected['columnAlias'][column['column']]" placeholder="Column alias" name="column-alias-{{rowIndex}}-{{colIndex}}" type = "text" class="column-input"/>
            </div>
            </mat-select>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="3">
          <mat-form-field *ngIf="selected.table && !isFirstTable">
            <mat-label>Select Join</mat-label>
            <mat-select [(ngModel)]="selected.join" name="join-{{rowIndex}}" (selectionChange)="setJoinData(selected, rowIndex)"
              [disabled]="selected.disabled" required>
              <mat-option *ngFor="let join of joinTypes" [value]="join">{{join | titlecase }}</mat-option>
            </mat-select>
            <mat-error> Please select type of join </mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="1">
          <button mat-stroked-button mat-icon-button isRoundButton="true" aria-label="Add table" (click)="addRow(rowIndex)"
            *ngIf="selected.table && selectedTablesForm.form.valid && isLastTable && !isDiffKeys">
            <mat-icon>add</mat-icon>
          </button>
        </mat-grid-tile>

        <mat-grid-tile colspan="1">
          <button mat-stroked-button mat-icon-button aria-label="Delete join" isRoundButton="true" (click)="deleteRow(rowIndex)"
            *ngIf="selected.table && isLastTable">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-grid-tile>
        <mat-grid-tile colspan="12" rowspan="2" *ngIf="selected.join && selected.join !== 'cross' && !isFirstTable">
        <!-- <mat-grid-tile colspan="12" rowspan="2" *ngIf="showKeys[rowIndex]"> -->
          <mat-card class="h-100 w-100">
            <mat-card-content>
              <mat-grid-list cols="12" rowHeight="4:3" *ngFor="let key of selected.keys; index as i; last as isLastKey; first as isFirstKey">
                  <!-- <mat-grid-list cols="12" rowHeight="4:3"> -->

                <mat-grid-tile colspan="3">
                  <mat-form-field>
                    <mat-label>Select primary key</mat-label>
                    <mat-select [(ngModel)]="key.primaryKeyName" name="primaryKey-{{rowIndex}}" [disabled]="selected.disabled"
                      (selectionChange)="setSelectedKey(selected, i, rowIndex, true)" required>
                      
                      <input matInput placeholder="search Column" class= "filter-input" (input)="filterKey($event.target.value,rowIndex,'primary')"/>
                        <div *ngIf="!noEntriesFoundColumn">
                          No Entries found
                        </div>

                      <mat-option *ngFor="let col of selected.joinData['table1']['columns']" [value]="col['column']"
                        title="{{col.data_type}}">
                        {{col.column}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select a primary key</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <mat-grid-tile colspan="2">
                  <mat-form-field>
                    <mat-label>Select operation</mat-label>
                    <mat-select [(ngModel)]="key.operation" name="operation-{{rowIndex}}" [disabled]="selected.disabled"
                      required>
                      <mat-option *ngFor="let operation of operations" [value]="operation">
                        {{operation}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select an operation</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <mat-grid-tile colspan="3">
                  <mat-form-field>
                    <mat-label>Select foreign key</mat-label>
                    <mat-select [(ngModel)]="key.foreignKeyName" name="foreignKey-{{rowIndex}}" [disabled]="selected.disabled"
                      (selectionChange)="setSelectedKey(selected, i, rowIndex)" required>

                      <input matInput placeholder="search Column" class= "filter-input" (input)="filterKey($event.target.value,rowIndex,'foreign')"/>
                      <div *ngIf="!noEntriesFoundColumn">
                        No Entries found
                      </div>

                      <mat-option *ngFor="let col of selected.joinData['table2']['columns']" [value]="col['column']"
                        title="{{col.data_type}}">
                        {{col.column}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select a foreign key</mat-error>
                  </mat-form-field>
                </mat-grid-tile>
              </mat-grid-list>
            </mat-card-content>
          </mat-card>

        </mat-grid-tile>
      </mat-grid-list>
    </form>
  </mat-card-content>
</mat-card> 

<button class="float-right btn btn-success" mat-button matStepperNext [disabled]="selectedTablesForm.form.invalid || isDiffKeys"
  (click)="createFormula()">Add to Formula Bar</button>

<app-joins-help-option></app-joins-help-option>