<mat-card>
  <mat-card-content>
    <form #selectedTablesForm="ngForm">
      <mat-grid-list cols="12" rowHeight="4:3"
        *ngFor="let selected of selectedTables; index as rowIndex; last as isLastTable; first as isFirstTable">
        <mat-grid-tile colspan="3" *ngIf="tables['tables'].length || tables['custom tables'].length">
          <mat-form-field>
            <mat-label>Select table/custom table</mat-label>
            <mat-select [(ngModel)]="selected.table" name="table-{{rowIndex}}"
              (selectionChange)="getRelatedTables(selected)" [disabled]="selected.disabled" required>
              <mat-optgroup label="Related Tables" [hidden]="!isRelated">
                <mat-option *ngFor="let table of tables['related tables']" [value]="table">
                  {{table.mapped_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Tables" *ngIf="tables['tables'].length">
                <mat-option *ngFor="let table of tables['tables']" [value]="table">
                  {{table.mapped_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Custom Tables" *ngIf="tables['custom tables'].length">
                <mat-option *ngFor="let table of tables['custom tables']" [value]="table">
                  {{table.custom_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
            </mat-select>
            <mat-error> Please select a table </mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="3">
          <mat-form-field *ngIf="selected.table">
            <mat-label>Select Columns</mat-label>
            <mat-select multiple [(ngModel)]="selected['columns']" name="columns-{{rowIndex}}"
              (selectionChange)="onTableColumnSelect()" [disabled]="selected.disabled" required>
              <mat-option *ngFor="let column of selected['table']['mapped_column_name']" [value]="column">
                {{column | uppercase}}
              </mat-option>
            </mat-select>
            <mat-error> Please select atleast one column</mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="3">
          <mat-form-field *ngIf="selected.table && selected['columns'].length && !isFirstTable">
            <mat-label>Select Join</mat-label>
            <mat-select [(ngModel)]="selected.join" name="join-{{rowIndex}}" (selectionChange)="setJoinData(rowIndex)"
              [disabled]="selected.disabled" required>
              <mat-option value="left">Left</mat-option>
              <mat-option value="right">Right</mat-option>
              <mat-option value="inner">Inner</mat-option>
              <mat-option value="outer">Outer</mat-option>
            </mat-select>
            <mat-error> Please select type of join </mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="1">
          <button mat-stroked-button mat-icon-button isRoundButton="true" aria-label="Add table" (click)="addRow(rowIndex)"
            *ngIf="selected.table && selected['columns'].length && isLastTable && !showKeys[rowIndex]"><!-- && (selectedTables.length < 2)">-->
            <mat-icon>add</mat-icon>
          </button>
        </mat-grid-tile>

        <mat-grid-tile colspan="1">
          <button mat-stroked-button mat-icon-button aria-label="Delete join" isRoundButton="true"
            (click)="deleteRow(rowIndex)" *ngIf="selected.table && isLastTable"><!--selected['columns'].length &&-->
            <mat-icon>delete</mat-icon>
          </button>
        </mat-grid-tile>

        <!-- <mat-grid-tile colspan="1">
          <button
            *ngIf="selected.table && selected['columns'].length && isLastTable && selected.join && !isFirstTable"
            mat-button color="primary" (click)="showKeys[rowIndex] = !showKeys[rowIndex]">Set Join</button>
        </mat-grid-tile> -->

        <mat-grid-tile colspan="12" rowspan="2" *ngIf="showKeys[rowIndex] && !isFirstTable">
          <mat-card style="width:100%; height:100%; min-height:200px; overflow-y:auto">
            <mat-card-content>
              <mat-grid-list cols="12"
                *ngFor="let key of selected.keys; index as i; last as isLastKey; first as isFirstKey">

                <mat-grid-tile colspan="3">
                  <mat-form-field>
                    <mat-label>Select primary key</mat-label>
                    <mat-select [(ngModel)]="key.primaryKey" name="primaryKey-{{i}}" [disabled]="selected.disabled"
                      (selectionChange)="validateKeySelection(selected, i, rowIndex)" required>
                      <mat-option *ngFor="let col of joinData[rowIndex]['table1']['columns']" [value]="col" title="{{col.data_type}}">
                        {{col.mapped_column}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select a primary key</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <mat-grid-tile colspan="2">
                  <mat-form-field>
                    <mat-label>Select operation</mat-label>
                    <mat-select [(ngModel)]="key.operation" name="operation-{{i}}" [disabled]="selected.disabled" required>
                      <mat-option *ngFor="let operation of operations" [value]="operation">
                        {{operation}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select an operation</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <mat-grid-tile colspan="3">
                  <mat-form-field>
                    <mat-label>Select foreign key</mat-label>
                    <mat-select [(ngModel)]="key.foreignKey" name="foreignKey-{{i}}" [disabled]="selected.disabled"
                      (selectionChange)="validateKeySelection(selected, i, rowIndex)" required>
                      <mat-option *ngFor="let col of joinData[rowIndex]['table2']['columns']" [value]="col" title="{{col.data_type}}">
                        {{col.mapped_column}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select a foreign key</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <!-- <mat-grid-tile colspan="2">
                  <mat-form-field *ngIf="selected.keys.length>1 && (key.primaryKey && key.operation && key.foreignKey) && !isLastKey">
                    <mat-label>Select operator</mat-label>
                    <mat-select [(ngModel)]="key.operator" name="operator-{{i}}">
                      <mat-option *ngFor="let operator of operators" [value]="operator">
                        {{operator}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </mat-grid-tile> -->

                <!-- <mat-grid-tile colspan="1">
                  <button mat-stroked-button mat-icon-button isRoundButton="true" aria-label="Add key"
                    (click)="addKey(selected)" *ngIf="isLastKey && key.primaryKey && key.foreignKey && key.operation">
                    <mat-icon>add</mat-icon>
                  </button>
                </mat-grid-tile>

                <mat-grid-tile colspan="1">
                  <button mat-stroked-button mat-icon-button aria-label="Delete join" isRoundButton="true"
                    (click)="deleteKey(selected, i)" *ngIf="!isFirstKey">
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-grid-tile> -->

              </mat-grid-list>
            </mat-card-content>
          </mat-card>

        </mat-grid-tile>

      </mat-grid-list>
    </form>
  </mat-card-content>
</mat-card>

<button class="float-right" mat-button matStepperNext [disabled]="selectedTablesForm.form.invalid" (click)="createFormula()">Next</button>