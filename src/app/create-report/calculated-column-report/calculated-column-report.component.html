<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" data-toggle="tab" role="tab" href="#exist">Existing Calculated Fields</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-toggle="tab" role="tab" href="#create">Create Calculated Field</a>
  </li>
</ul>
<div class="tab-content">
  <div role="tabpanel" id="exist" class="container tab-pane active"><br>
    <div class="form-group">
      <input type="text" placeholder="Search for Calculated Field(s)" class="form-control search options" (input)="filterList($event.target.value)" />
    </div>
    <div *ngIf="isLoad" class="spinner text-center">
      <img src="assets/spinner.gif">
    </div>
    <ul *ngIf="calFields.length" class="list-group scroll-area options">
      <li class="list-group-item border-0" *ngFor="let item of calFields;let i=index;">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="radio" id="calculated{{i}}" name="calculated" (change)="onSelectCal(item.calculated_field_name)">
          <label class="form-check-label" style="font-weight:normal" for="calculated{{i}}">{{item.calculated_field_name}}</label>
        </div>
      </li>
    </ul>
    <div *ngIf="!calFields.length && !isLoad" class="notables">No calculated fields available</div>
    <div><b> Calculated Field Formula:</b></div>
    <div class="input-group mb-1">
      <textarea class="form-control" style="float:float;width:93%" rows="3" disabled>{{selectedObj}}</textarea>
      <div class="btn-group-vertical" style="float:right;width:7%;">
        <button type="button" class="btn btn-primary btn-sm">Apply</button>
        <button type="button" class="btn btn-primary btn-sm">Delete</button>
      </div>
    </div>
  </div>

     <!-- Create new Calculated Column -->
  <div role="tabpanel" id="create" class="tab-pane">
    <div class="container-fluid">
      <!-- <div> -->
      <div class="col-sm-8 pt-20">

        <div class="form-group row" *ngFor="let column of columnNames;let k = index;last as isLast">
          <label class="col-form-label col-sm-3">Column Name</label>
          <input type="text" class="form-control col-sm-8 mb-4" [(ngModel)]="column['col']" placeholder="Column name" (input)="checkDuplicateColumn(column['col'],k,$event)"/>
            
          <button *ngIf="isLast" class="icon col-sm-1 h-30"  [ngClass]="{'blocked':isDuplicate.column}" (click)="addNew('column')" title="Add Columns">
            <svg class="wh-21" viewBox="0 0 24 24">
              <path fill="#000000" d="M17,13H13V17H11V13H7V11H11V7H13V11H17M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
            </svg>
          </button>

          <button *ngIf="!isLast" class="icon col-sm-1 h-30" (click)="deleteOld('column',k)" title="Remove Columns">
            <svg class="wh-21" viewBox="0 0 24 24">
              <path fill="#000000" d="M17,13H7V11H17M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
            </svg>
          </button>
        </div>

        <div class="form-group row"  *ngIf = "isDuplicate.column">
          <div class="col-sm-9 offset-sm-3 pl-0">
            <span class="red"> Duplicate column</span>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-form-label col-sm-3">Choose Column</label>
          <input type="text" id= "columnId" class="form-control col-sm-9 mb-4" list="columns" value="" [(ngModel)]="selected" (change)="onSelect(selected,$event)"
            placeholder="Search columns" />
          <datalist id="columns">
            <option *ngFor="let col of tableColList;let i = index;" [ngValue]="col" value="{{col.column}}"  id="{{i}}">{{col.column}}</option>
          </datalist>
        </div>

        <div class="form-group row" *ngIf="selectedColumns.length">
          <div class="col-sm-9 offset-sm-3 pl-0">
            <p class="font-weight-bold">Click on column names to add to formula</p>
            <div id="selected-columns">
              <span class="selected-item" *ngFor="let col of selectedColumns; let i=index" (click)="addToFormula(col)">{{col}}
                <button type="button" class="close" (click)="deleteSelected('column',i)" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </span>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <label class="col-form-label col-sm-3">Parameter</label>
          <input type="text" class="form-control col-sm-9 mb-4" list="parameters" [(ngModel)]="selectedParam"
            (change)="onSelect(selectedParam)" placeholder="{{parameters.length == 0?'No parameter to search':'Search parameters'}}" />
          <datalist id="parameters">
            <option *ngFor="let param of parameters" [value]="param">{{param}}</option>
          </datalist>
        </div>

        <div class="form-group row" *ngIf="selectedParamList.length">
          <div class="col-sm-9 offset-sm-3 pl-0">
            <p class="font-weight-bold">Click on parameter names to add to formula</p>
            <div id="selected-columns">
              <span class="selected-item" *ngFor="let param of selectedParamList; let i=index" (click)="addToFormula(param)">{{param}}
                <button type="button" class="close" (click)="deleteSelected('param',i)" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </span>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <label class="mb-0 col-sm-3">Functions:</label>
          <div class="wrapper col-sm-9">
            <span class="action-item" *ngFor="let function of functionsList[category]" (click)="addToFormula(function)">
              {{function}}
            </span>
          </div>
        </div>

        <div class="form-group row">
          <label class="mb-0 col-sm-3">Custom Input: </label>
          <input type="text" class="form-control mb-4 col-sm-6" [(ngModel)]="selectedInput" />
          <button type="button" class="btn btn-primary ml-2 h-33" (click)="onApply(selectedInput)" [disabled]="selectedInput == ''">Apply</button>
        </div>
  
        <div class="form-group row" *ngIf="customInput.length">
          <div class="col-sm-9 offset-sm-3 pl-0">
            <p class="font-weight-bold">Click on inputs to add to formula</p>
            <span class="selected-item" *ngFor="let inp of customInput; let i=index" (click)="addToFormula(inp)">{{inp}}
              <button type="button" class="close" (click)="deleteSelected('custom',i)" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </span>
          </div>
        </div>

        <div class="form-group row mb-4" *ngFor="let formula of formulas;let i = index; last as isLast;">
          <label class="mb-0 col-sm-3">Formula:</label>
          <div class="wrapper mb-0 col-sm-8" [ngClass]="{'blocked':!formula['disabled']}">
            <span class="is-function" appTooltip *ngFor="let col of formula.formulaColumns;let j = index">
              {{col}}
              <span class="tooltipDiv">
                <button class="icon" (click)="replaceFormula(col,i,j)" title="Replace">
                  <svg width= '14' height='14' viewBox="0 0 24 24">
                    <path fill="#ffffff" d="M11,6C12.38,6 13.63,6.56 14.54,7.46L12,10H18V4L15.95,6.05C14.68,4.78 12.93,4 11,4C7.47,4 4.57,6.61 4.08,10H6.1C6.56,7.72 8.58,6 11,6M16.64,15.14C17.3,14.24 17.76,13.17 17.92,12H15.9C15.44,14.28 13.42,16 11,16C9.62,16 8.37,15.44 7.46,14.54L10,12H4V18L6.05,15.95C7.32,17.22 9.07,18 11,18C12.55,18 14,17.5 15.14,16.64L20,21.5L21.5,20L16.64,15.14Z" />
                  </svg>
                </button>
    
                <button class="icon" (click)="deleteFormula(col,i,j)" title="Delete">
                  <svg width= '14' height='14' viewBox="0 0 24 24">
                    <path fill="#ffffff" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />
                  </svg>
                </button>
              </span>
            </span>
          </div>
          <!-- </div> -->
          <button *ngIf="isLast" class="icon" [ngClass]="{'blocked': columnNames.length == formulas.length}" (click)="addNew('formula')" title="Add Formula">
            <svg class="wh-21" viewBox="0 0 24 24">
              <path fill="#000000" d="M17,13H13V17H11V13H7V11H11V7H13V11H17M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
            </svg>
          </button>

          <button *ngIf="!isLast" class="icon" (click)="editFormulaSec(i)" title="Edit">
            <svg class="wh-21" viewBox="0 0 24 24">
                <path fill="#000000" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
            </svg>
          </button>

          <button *ngIf="!isLast" class="icon" (click)="deleteOld('formula',i)" title="Delete Formula">
            <svg class="wh-21" viewBox="0 0 24 24">
              <path fill="#000000" d="M17,13H7V11H17M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" />
            </svg>
          </button>
        </div>
        <div class="form-group row"  *ngIf = "isDuplicate.formula">
          <div class="col-sm-9 offset-sm-3 pl-0">
            <span class="red"> Duplicate formula</span>
          </div>
        </div>
      </div>
      
      
      
      <div id="functions-list" class="col-sm-4 pr-0">
        <div class="card">
          <div class="card-head">More Functions</div>
          <div class="card-body">
            <ul class="list-group">
              <li class="border-0 list-group-item" *ngFor="let function of functionsList  | keyvalue" [ngClass]="{'active-category': (this.category === function.key)}"
              (click)="setCategory(function.key)">
                  {{function.key | titlecase}}
              </li>
            </ul>
          </div>
        </div>
      </div>
    <!-- </div> -->
    </div>
  <!-- <div><b> Calculated Field Formula:</b></div> -->
    <div class="input-group mb-1">
      <textarea class="form-control" style="float:float;width:93%" rows="3" disabled>{{createCalculatedQuery}}</textarea>
      <div class="btn-group-vertical" style="float:right;width:7%;">
        <button type="button" class="btn btn-primary btn-sm" (click)="apply()" [disabled]="isDuplicate.formula || isDuplicate.column || columnNames.length != formulas.length">Apply</button>
        <button type="button" class="btn btn-primary btn-sm">Delete</button>
      </div>
    </div>
  </div>
</div>