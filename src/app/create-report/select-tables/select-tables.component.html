<mat-card>
  <div id="info">
    <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#joinHelp">
      <svg viewBox="0 0 24 24">
        <path fill="#000000" d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20,12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M11,17H13V11H11V17Z" />
      </svg>
    </button>
  </div>

  <mat-card-content>
    <mat-label *ngIf="errData">Choose semantic to get tables</mat-label>
    <form #selectedTablesForm="ngForm">
      <mat-grid-list cols="12" rowHeight="4:3" *ngFor="let selected of selectedTables; index as rowIndex; last as isLastTable; first as isFirstTable">
        <mat-grid-tile colspan="3" *ngIf="tables['tables'].length || tables['custom tables'].length">
          <mat-form-field>
            <mat-label>Select table/custom table</mat-label>
            <mat-select [(ngModel)]="selected.tableId" name="table-{{rowIndex}}" (selectionChange)="setSelectedTable(selected)" 
            [disabled]="selected.disabled" required>
              <mat-optgroup label="Related Tables" [hidden]="!isRelated">
                <mat-option *ngFor="let table of tables['related tables']" [value]="table['mapped_table_id']">
                  {{table.mapped_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Tables" [hidden]="!tables['tables'].length">
                <mat-option *ngFor="let table of tables['tables']" [value]="table['sl_tables_id']">
                  {{table.mapped_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
              <mat-optgroup label="Custom Tables" [hidden]="!tables['custom tables'].length">
                <mat-option *ngFor="let table of tables['custom tables']" [value]="table['custom_table_id']">
                  {{table.custom_table_name | uppercase}}
                </mat-option>
              </mat-optgroup>
            </mat-select>
            <mat-error> Please select a table </mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="3">
          <mat-form-field *ngIf="selected.table">
            <mat-label>Select Columns</mat-label>
            <mat-select *ngIf="selected['table']['mapped_column_name']" multiple [(ngModel)]="selected['columns']" name="columns-{{rowIndex}}" 
            (selectionChange)="onTableColumnSelect()" [disabled]="selected.disabled" required>
              <mat-option *ngFor="let column of selected['table']['column_properties']" [value]="column['column']">
                {{column['column'] | uppercase}}
              </mat-option>
            </mat-select>
            <mat-error> Please select atleast one column</mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="3">
          <mat-form-field *ngIf="selected.table && selected['columns'].length && !isFirstTable">
            <mat-label>Select Join</mat-label>
            <mat-select [(ngModel)]="selected.join" name="join-{{rowIndex}}" (selectionChange)="setJoinData(rowIndex)"
              [disabled]="selected.disabled" required>
              <mat-option value="left">Left</mat-option>
              <mat-option value="right">Right</mat-option>
              <mat-option value="inner">Inner</mat-option>
              <mat-option value="outer">Outer</mat-option>
            </mat-select>
            <mat-error> Please select type of join </mat-error>
          </mat-form-field>
        </mat-grid-tile>

        <mat-grid-tile colspan="1">
          <button mat-stroked-button mat-icon-button isRoundButton="true" aria-label="Add table" (click)="addRow(rowIndex)" 
          *ngIf="selected.table && selectedTablesForm.form.valid && isLastTable">
            <mat-icon>add</mat-icon>
          </button>
        </mat-grid-tile>

        <mat-grid-tile colspan="1">
          <button mat-stroked-button mat-icon-button aria-label="Delete join" isRoundButton="true" (click)="deleteRow(rowIndex)" 
          *ngIf="selected.table && isLastTable">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-grid-tile>

        <mat-grid-tile colspan="12" rowspan="2" *ngIf="showKeys[rowIndex] && !isFirstTable">
          <mat-card style="width:100%; height:100%; min-height:200px; overflow-y:auto">
            <mat-card-content>
              <mat-grid-list cols="12" *ngFor="let key of selected.keys; index as i; last as isLastKey; first as isFirstKey">

                <mat-grid-tile colspan="3">
                  <mat-form-field>
                    <mat-label>Select primary key</mat-label>
                    <mat-select [(ngModel)]="key.primaryKeyName" name="primaryKey-{{i}}" [disabled]="selected.disabled"
                      (selectionChange)="setSelectedKey(selected, i, rowIndex, true)" required>
                      <!-- TODO: when data type is undefined-->
                      <mat-option *ngFor="let col of joinData[rowIndex]['table1']['columns']" [value]="col['column']"
                        title="{{col.data_type}}">
                        {{col.column}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select a primary key</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <mat-grid-tile colspan="2">
                  <mat-form-field>
                    <mat-label>Select operation</mat-label>
                    <mat-select [(ngModel)]="key.operation" name="operation-{{i}}" [disabled]="selected.disabled"
                      required>
                      <mat-option *ngFor="let operation of operations" [value]="operation">
                        {{operation}}
                      </mat-option>
                    </mat-select>
                    <mat-error> Please select an operation</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <mat-grid-tile colspan="3">
                  <mat-form-field>
                    <mat-label>Select foreign key</mat-label>
                    <mat-select [(ngModel)]="key.foreignKeyName" name="foreignKey-{{i}}" [disabled]="selected.disabled"
                      (selectionChange)="setSelectedKey(selected, i, rowIndex)" required>
                      <mat-option *ngFor="let col of joinData[rowIndex]['table2']['columns']" [value]="col['column']"
                        title="{{col.data_type}}">
                        {{col.column}}
                      </mat-option>
                    </mat-select>

                    <mat-error> Please select a foreign key</mat-error>
                  </mat-form-field>
                </mat-grid-tile>

                <!-- <mat-grid-tile colspan="2">
                  <mat-form-field *ngIf="selected.keys.length>1 && (key.primaryKey && key.operation && key.foreignKey) && !isLastKey">
                    <mat-label>Select operator</mat-label>
                    <mat-select [(ngModel)]="key.operator" name="operator-{{i}}">
                      <mat-option *ngFor="let operator of operators" [value]="operator">
                        {{operator}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </mat-grid-tile> -->

                <!-- <mat-grid-tile colspan="1">
                  <button mat-stroked-button mat-icon-button isRoundButton="true" aria-label="Add key"
                    (click)="addKey(selected)" *ngIf="isLastKey && key.primaryKey && key.foreignKey && key.operation">
                    <mat-icon>add</mat-icon>
                  </button>
                </mat-grid-tile>

                <mat-grid-tile colspan="1">
                  <button mat-stroked-button mat-icon-button aria-label="Delete join" isRoundButton="true"
                    (click)="deleteKey(selected, i)" *ngIf="!isFirstKey">
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-grid-tile> -->

              </mat-grid-list>
            </mat-card-content>
          </mat-card>

        </mat-grid-tile>
      </mat-grid-list>
    </form>
  </mat-card-content>
</mat-card>

<button class="float-right btn btn-success" mat-button matStepperNext [disabled]="selectedTablesForm.form.invalid" (click)="createFormula()">Next</button>

<app-joins-help-option></app-joins-help-option>