<mat-card>
    <mat-accordion>
      <mat-expansion-panel style="margin-bottom: 15px;">
        <mat-expansion-panel-header>
          <mat-panel-title style="font-weight: bold;">
            Existing Conditions
          </mat-panel-title>
          <mat-panel-description> </mat-panel-description>
        </mat-expansion-panel-header>
        <mat-grid-list cols="2" rowHeight="100px" *ngIf="originalExisting.length">
          <mat-grid-tile [colspan]="1">
            <mat-form-field style="width: 100%">
              <input matInput [formControl]="queryField" placeholder="Search here" />
            </mat-form-field>
          </mat-grid-tile>
        </mat-grid-list>
        <div style="overflow: auto;height: 200px;" *ngIf="existingList.length">
        <section *ngFor="let item of existingList">
          <mat-checkbox id="{{item.calculated_field_id}}"
            class="checkobox"
            [checked]="item.checked"
            (change)="toggle(item,$event)">{{ item.calculated_field_name }}</mat-checkbox>         
          <button mat-stroked-button mat-icon-button aria-label="Delete Field" isRoundButton="true" class="mini-fab"
          (click)="deleteField(item.calculated_field_id)" title="Delete Field">
          <mat-icon>delete</mat-icon>
        </button>          
        </section>
        </div>
        <p *ngIf="!existingList.length" style="text-align: center;">No Data Available</p>
      </mat-expansion-panel>
    </mat-accordion>  
    <mat-card>
      <p style="font-weight: bold;margin-left: 7px;">Define New Condition</p>    
      <table class="table">
          <thead style="width:100%;">
            <tr>
              <th class="text-center" *ngFor="let h of headers" scope="col">
                <b>{{h}}</b>
              </th>
              <!-- <button class="sideButtons" *ngIf="createFormula.length == 0" (click)="addColumnBegin()" title="Add row">
                <i class="material-icons" style="color:#afafb5;">
                  add_circle
                </i>
              </button> -->
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let con of createFormula;let i = index;">
              <td width="5%">
                <input type="text" class="brackets" (keypress)="checkOpen($event)" [(ngModel)]="con['open']" />
              </td>
              <td width="35%">
                <select required class="dropdown" [(ngModel)]="con.table" (change)="onTableSelection($event, con)">
                  <option class="text-center" *ngFor="let item of tables" [value]="item.alias">{{item.name}}</option>
                </select>
              </td>
              <!-- <td width="20%">
                <select required class="dropdown" [(ngModel)]="con.attributes">
                  <option class="text-center" *ngFor="let column of con.columns" [ngValue]="column">{{column}}</option>
                </select>
              </td> -->
              <td width="10%">
                <select required class="dropdown" [(ngModel)]="con.condition">
                  <option class="text-center" *ngFor="let x of conditionList" [ngValue]="x">{{x}}</option>
                </select>
              </td>
              <td width="35%">
                <!-- <div style="display:inline-block;">
                  <input type="text" class="textarea" style="border-color: #afafb5;width: 400px;" rows="1"
                    [(ngModel)]="con.values" />
                  <input type="file" style="display: none;" accept=".xls,.xlsx" id="valueInput{{i}}"
                    (click)="uploadFile($event,con,i)">
                  <button class="sideButtons" (click)="triggerFileBtn(i)" style="margin-top:3px;" title="Upload excel">
                    <svg style="width:24px;height:24px;" viewBox="0 0 24 24">
                      <path fill="#afafb5" d="M9,16V10H5L12,3L19,10H15V16H9M5,20V18H19V20H5Z" />
                    </svg>
                  </button>
                </div> -->
                   <form style="display: flex; flex-direction: column; height: 50%;">
        <mat-form-field class="stretch-height">
          <mat-label>Enter Formula</mat-label>
          <textarea
            matInput
            [formControl]="queryTextarea" (input)="inputValue($event.target.value)"
            [matAutocomplete]="auto"
          ></textarea>
          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onSelectionChanged($event)" >
              <mat-optgroup *ngFor="let option of results " [label]="option.groupName">
                <mat-option *ngFor="let opt of option.values " [value]="opt">
                  {{opt}}
                </mat-option>
              </mat-optgroup>
            </mat-autocomplete>
          <p *ngIf="isError">Bracket is required</p>
          <mat-error *ngIf="!queryTextarea.valid">Duplicate Formula!</mat-error>
        </mat-form-field>
      </form>
              </td>
              <td width="5%">
                <input type="text" class="brackets" (keypress)="checkClose($event)" [(ngModel)]="con['close']" />
              </td>
              <td width="3%" style="border-width: 0px;">
                <select required class="dropdown" [(ngModel)]="con.operator">
                  <option class="text-center" *ngFor="let x of operator" [ngValue]="x == '-'? '': x">{{x}}</option>
                </select>
              </td>
              <div style="display:inline-block">
                <button class="sideButtons" style="margin-left: -13px;" (click)="addColumn(con)" title="Add row">
                  <i class="material-icons" style="color:#afafb5;font-size: 18px;">
                    add_circle
                  </i>
                </button>
                <button *ngIf="createFormula.length >= 2" class="sideButtons" title="Remove row" (click)="removeColumn(con)">
                  <i class="material-icons" style="color:#afafb5;font-size: 18px;margin-left: -11px;">
                    remove_circle
                  </i>
                </button>
              </div>
            </tr>
          </tbody>
        </table>    
      <mat-grid-list cols="2" rowHeight="100px">
          <mat-grid-tile [colspan]="1">
              
            <mat-form-field style="width: 100%">
              <input matInput [formControl]="columnName" placeholder="Save As" />
              <mat-error *ngIf="!columnName.valid">Duplicate Name!</mat-error>
            </mat-form-field>
          </mat-grid-tile>
          <!-- <mat-grid-tile>
                <button [disabled]="!columnName.value || !queryTextarea.value || !columnName.valid || !queryTextarea.valid" 
                mat-stroked-button mat-icon-button isRoundButton="true" aria-label="Add Field" (click)="add()">
                <mat-icon>add</mat-icon>
              </button>
          </mat-grid-tile>
          <mat-grid-tile>
              <button [disabled]="!columnName.value || !queryTextarea.value || !columnName.valid || !queryTextarea.valid" 
              mat-stroked-button mat-icon-button isRoundButton="true" aria-label="Add Field" (click)="add()">
              <mat-icon>delete</mat-icon>
            </button>
        </mat-grid-tile> -->
        </mat-grid-list>      
      <mat-chip-list #chipList aria-label="">
        <mat-chip
          *ngFor="let chip of chips"
          [selectable]="selectable"
          [removable]="removable"
          (removed)="remove(chip)"
          (click)="getSelected(chip)">
          {{ chip.name }}
          <mat-icon matChipRemove *ngIf="removable">cancel</mat-icon>
        </mat-chip>
      </mat-chip-list>
    </mat-card>
  </mat-card>  
  <button mat-button matStepperPrevious>Back</button> 
  <button mat-button matStepperNext (click)="next()" class="float-right">Finish</button>  